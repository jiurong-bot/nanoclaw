# 🔍 NanoClaw 監控面板系統完整規劃

## 系統架構概覽

```
監控系統 (Monitoring System)
│
├─ 🔍 硬體監控層 (Hardware Layer)  [60 秒週期]
│  ├─ CPU 監控
│  ├─ 內存監控
│  ├─ 電池監控
│  ├─ 磁盤監控
│  ├─ 網絡監控
│  └─ 溫度告警
│
├─ 📋 軟體監控層 (Software Layer)  [120 秒週期]
│  ├─ 進程監控
│  ├─ 內存洩漏檢測
│  ├─ 依賴檢查
│  └─ 日誌分析
│
├─ 💚 服務健康層 (Health Layer)    [300 秒週期]
│  ├─ AI 模型檢測
│  ├─ 數據庫檢測
│  ├─ 緩存系統檢測
│  ├─ 內存系統檢測
│  └─ 整體評分
│
└─ 🚨 告警系統 (Alert System)      [實時]
   ├─ 異常檢測引擎
   ├─ 優先順序評級
   ├─ Telegram 推送
   └─ 本地告警歷史
```

---

## 📊 詳細功能規劃

### **第 1 層：硬體監控（60 秒執行一次）**

#### 1.1 CPU 監控
```javascript
// 監控項目
- OS 平均負載 (1min, 5min, 15min)
- CPU 使用率百分比
- 核心數量
- 進程 CPU 時間

// 告警條件
- ⚠️ 黃色警告：> 70%
- 🔴 紅色告警：> 90%

// 數據源
- os.loadavg()
- /proc/stat (Linux)
- top 命令
```

#### 1.2 內存監控
```javascript
// 監控項目
- 總內存
- 已用內存
- 可用內存
- 使用率百分比
- 緩衝/快取內存

// 告警條件
- ⚠️ 黃色警告：> 75%
- 🔴 紅色告警：> 90%

// 數據源
- os.totalmem() / os.freemem()
- /proc/meminfo
- free 命令
```

#### 1.3 電池監控（Termux 特化）
```javascript
// 監控項目
- 電池百分比
- 實時電池溫度
- 健康狀態 (GOOD/WARNING/CRITICAL)
- 充電狀態 (是否充電中)
- 實可用時間

// 告警條件
- ⚠️ 黃色警告：20% 以下
- 🔴 紅色告警：10% 以下
- 🔴 過熱告警：> 40°C

// 數據源
- termux-battery-status (JSON)
```

#### 1.4 磁盤監控
```javascript
// 監控項目
- 總容量
- 已用容量
- 可用容量
- 使用率百分比
- I/O 讀寫速度

// 告警條件
- ⚠️ 黃色警告：> 80%
- 🔴 紅色告警：> 95%

// 數據源
- df -h /
- /proc/diskstats
```

#### 1.5 網絡監控
```javascript
// 監控項目
- 連接狀態 (連接/離線)
- 當前 IP 地址
- Ping 延遲 (ms)
- 上行/下行速度

// 告警條件
- 🔴 離線告警：無連接
- ⚠️ 延遲警告：> 1000ms

// 數據源
- ping 8.8.8.8
- ifconfig / ip addr
- speedtest (可選)
```

#### 1.6 溫度監控
```javascript
// 監控項目
- CPU 溫度
- 電池溫度
- 系統溫度

// 告警條件
- ⚠️ 黃色警告：> 50°C
- 🟠 橙色告警：> 60°C
- 🔴 紅色告警：> 75°C (過熱)

// 自動行為
- 高溫時：自動降頻 / 限流
```

---

### **第 2 層：軟體監控（120 秒執行一次）**

#### 2.1 進程監控
```javascript
// 監控項目
- Node.js 進程狀態
- 進程 PID
- CPU 時間
- 內存占用（RSS/Heap）
- 運行時間
- 子進程計數

// 告警條件
- 🔴 進程崩潰：PID 不存在
- ⚠️ 內存異常：> 200MB

// 數據源
- ps aux | grep node
- /proc/[PID]/stat
- process.memoryUsage()
```

#### 2.2 內存洩漏檢測
```javascript
// 監控項目
- 堆內存使用趨勢（過去 30 分鐘）
- 內存增長速率（MB/min）
- GC 垃圾回收頻率
- 內存回收成功率

// 洩漏判定算法
if (內存增長趨勢 > 1MB/min for 10min) {
  觸發內存洩漏告警
  建議重啟
}

// 數據源
- process.memoryUsage().heapUsed
- 定時樣本收集
```

#### 2.3 依賴完整性檢查
```javascript
// 監控項目
- npm 包是否完整
- package-lock.json 校驗
- 關鍵依賴版本檢查
- 已知漏洞掃描（npm audit）

// 檢查項目
✓ dotenv
✓ telegraf
✓ groq-sdk
✓ lowdb
✓ axios

// 告警條件
- 🔴 缺少依賴：無法 require
- ⚠️ 版本不匹配：package.json vs node_modules
```

#### 2.4 日誌錯誤分析
```javascript
// 監控項目
- 最近 1 小時的錯誤計數
- 錯誤分類（API / 內存 / 網絡 etc）
- 錯誤趨勢（上升/下降）
- 最常見的 3 個錯誤

// 告警條件
- ⚠️ 黃色警告：錯誤 > 5/hour
- 🔴 紅色告警：錯誤 > 20/hour

// 數據源
- console.error() 日誌
- App 內部錯誤清單
```

---

### **第 3 層：服務健康（300 秒執行一次）**

#### 3.1 AI 模型服務檢測
```javascript
// 監控項目
- Groq API 連通性
- 響應延遲 (ms)
- 最近 24h 請求成功率
- 最近 24h 平均響應時間
- 服務狀態碼統計

// 健康判定
✅ 健康：連接正常 + 成功率 > 95%
⚠️  警告：成功率 80-95%
🔴 故障：成功率 < 80% 或無法連接

// 測試方式
- 發送測試 Prompt：'test'
- 記錄響應時間
- 檢查返回格式
```

#### 3.2 數據庫連接檢測
```javascript
// 監控項目
- lowdb 數據庫檔案完整性
- memory.json 檔案大小
- 最後修改時間
- 讀寫權限檢查
- 數據有效性驗證

// 健康判定
✅ 健康：檔案完整 + 可讀寫
⚠️  警告：檔案接近損壞
🔴 故障：檔案丟失或無法訪問

// 檢查項目
✓ JSON 格式有效
✓ history 陣列完整
✓ soul_memory 陣列完整
✓ 文件大小合理 (< 50MB)
```

#### 3.3 緩存系統檢測
```javascript
// 監控項目
- 內存快取使用率
- 快取命中率
- 最舊快取時間

// 健康判定
✅ 健康：命中率 > 70%
⚠️  警告：命中率 50-70%
🔴 故障：命中率 < 50%

// 注：當前版本使用 lowdb，暫無快取層
// Step 5 時可添加 Redis 快取
```

#### 3.4 內存系統健康度
```javascript
// 監控項目
- 堆內存使用率
- 堆外內存 (Buffer/外部)
- GC 暫停時間
- 內存碎片率

// 計算公式
健康度 = (100 - 使用率%) * 0.7 
         + (GC 成功率) * 0.3

// 健康判定
✅ 健康：> 70
⚠️  警告：50-70
🔴 故障：< 50
```

#### 3.5 整體健康評分（0-100）
```javascript
整體評分 = 
  硬體評分 (30%) +
  軟體評分 (30%) +
  服務評分 (25%) +
  告警評分 (15%)

// 子評分計算
硬體評分 = 
  CPU (40%) + 
  內存 (30%) + 
  電池 (20%) + 
  溫度 (10%)

// 健康判定
✅ 優秀：> 80
⚠️  良好：60-80
🟠 一般：40-60
🔴 故障：< 40
```

---

### **第 4 層：主動告警系統（實時）**

#### 4.1 告警優先順序

```
🔴 P0（嚴重） - 立即推送
   ├─ 進程崩潰
   ├─ 內存用完 (> 95%)
   ├─ 數據庫故障
   └─ API 完全無法連接

🟠 P1（高） - 5 秒內推送
   ├─ 過熱 (> 70°C)
   ├─ CPU 過高 (> 90%)
   ├─ 內存接近滿 (> 85%)
   ├─ 內存洩漏檢測
   └─ 電池過低 (< 15%)

⚠️  P2（中） - 30 秒內推送
   ├─ CPU 高 (70-90%)
   ├─ 內存高 (75-85%)
   ├─ 網絡延遲 (> 1s)
   ├─ 錯誤率上升
   └─ 磁盤空間不足

💡 P3（低） - 每 5 分鐘匯總推送
   ├─ 普通警告
   ├─ 信息性日誌
   └─ 性能建議
```

#### 4.2 告警引擎實現

```javascript
class AlertSystem {
  // 實時異常檢測
  detectAnomaly() {
    檢查所有指標
    if (違反閾值) {
      計算優先順序
      立即推送通知
      記錄告警歷史
    }
  }

  // 智能去重
  deduplicateAlert() {
    避免重複推送相同告警
    同一告警 30 秒內只推送 1 次
  }

  // 告警聚合
  aggregateAlerts() {
    P3 告警每 5 分鐘匯總推送
    避免刷屏
  }

  // 告警恢復
  onAlertRecovery() {
    當指標恢復正常時
    推送「告警已解除」通知
  }
}
```

#### 4.3 告警內容格式

```
🔴 [嚴重] 內存告警
時間：2026-02-25 14:30:45
狀態：使用率 92% (超過閾值 90%)

📊 詳情：
  總內存：4.0 GB
  已用：3.68 GB
  可用：0.32 GB
  趨勢：↑ 快速上升 (+5MB/min)

💡 建議：
  1. 強制執行垃圾回收
  2. 監視內存洩漏
  3. 如果持續上升，考慮重啟

🔗 查看詳細報告：/status
```

---

## 📈 實現路線圖

### **第 1 階段：基礎監控（當前 V81.0-L2）**
- ✅ 硬體基礎監控（CPU/電池/磁盤）
- ✅ 簡單告警機制
- ✅ Telegram 推送

### **第 2 階段：完整監控（下一步）**
```
這個規劃文檔中的所有功能
預計 8-10 小時開發
```

**任務分解：**
- [ ] Task 1：硬體監控完整化（2h）
- [ ] Task 2：軟體監控系統（2h）
- [ ] Task 3：服務健康檢測（2h）
- [ ] Task 4：告警引擎（2h）
- [ ] Task 5：儀表板 UI（1h）
- [ ] Task 6：測試 & 最佳化（1h）

### **第 3 階段：高級功能（未來）**
- 🔮 數據持久化（InfluxDB）
- 🔮 歷史趨勢分析
- 🔮 預測性告警
- 🔮 自動修復機制

---

## 💾 數據存儲方案

### **告警歷史結構**

```javascript
{
  "alerts": [
    {
      "id": "alert_001",
      "timestamp": "2026-02-25T14:30:45Z",
      "level": "P0",
      "category": "MEMORY",
      "title": "內存告警",
      "message": "使用率 92%",
      "metrics": {
        "current": 92,
        "threshold": 90,
        "unit": "%"
      },
      "status": "active" // active / resolved
    }
  ]
}
```

### **監控數據採樣**

```javascript
{
  "samples": [
    {
      "timestamp": "2026-02-25T14:30:00Z",
      "cycle": 60, // 秒
      "hardware": {
        "cpu": 45,
        "memory": 62,
        "battery": 88,
        "temp": 38
      },
      "health_score": 85
    }
  ]
}
```

---

## 🎯 關鍵指標定義

| 指標 | 綠色 ✅ | 黃色 ⚠️ | 紅色 🔴 |
|------|--------|--------|--------|
| CPU | < 70% | 70-90% | > 90% |
| 內存 | < 75% | 75-85% | > 85% |
| 電池 | > 30% | 15-30% | < 15% |
| 溫度 | < 50°C | 50-60°C | > 60°C |
| 磁盤 | < 80% | 80-95% | > 95% |
| API 成功率 | > 95% | 80-95% | < 80% |
| 錯誤率 | < 1/min | 1-5/min | > 5/min |

---

## 📋 配置文件示例

```javascript
// monitoring.config.js
module.exports = {
  cycles: {
    hardware: 60,      // 60 秒
    software: 120,     // 120 秒
    health: 300        // 300 秒
  },
  
  thresholds: {
    cpu: { warning: 70, critical: 90 },
    memory: { warning: 75, critical: 85 },
    temperature: { warning: 50, critical: 75 },
    battery: { warning: 20, critical: 10 }
  },

  alerts: {
    deduplicate_window: 30,     // 30 秒內同一告警只推送 1 次
    aggregate_interval: 300,    // P3 告警每 5 分鐘匯總
    retention_days: 30          // 保留最近 30 天的告警歷史
  }
};
```

---

## 🚀 下一步行動

**你想要：**
1. ✅ **立即實現完整監控系統** → 我開始開發
2. ⏳ **先實現部分功能** → 優先實現哪些？
3. 📋 **先調整這份規劃** → 有改進建議嗎？

---

*規劃版本：V1.0*
*日期：2026-02-25*
*狀態：待實現*
